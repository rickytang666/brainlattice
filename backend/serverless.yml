service: brainlattice-backend
frameworkVersion: "3"
useDotenv: true

provider:
  name: aws
  region: us-east-1
  stage: dev
  ecr:
    # builds docker image from backend/Dockerfile
    images:
      appimage:
        path: ./
        file: Dockerfile
  environment:
    # pass env vars to lambda
    DATABASE_URL: ${env:DATABASE_URL}
    R2_BUCKET: ${env:R2_BUCKET}
    R2_ACCOUNT_ID: ${env:R2_ACCOUNT_ID}
    R2_ACCESS_KEY_ID: ${env:R2_ACCESS_KEY_ID}
    R2_SECRET_ACCESS_KEY: ${env:R2_SECRET_ACCESS_KEY}
    R2_S3_API_URL: ${env:R2_S3_API_URL}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    GEMINI_API_KEY: ${env:GEMINI_API_KEY}
    UPSTASH_REDIS_REST_URL: ${env:UPSTASH_REDIS_REST_URL}
    UPSTASH_REDIS_REST_TOKEN: ${env:UPSTASH_REDIS_REST_TOKEN}
    QSTASH_URL: ${env:QSTASH_URL}
    QSTASH_TOKEN: ${env:QSTASH_TOKEN}
    QSTASH_CURRENT_SIGNING_KEY: ${env:QSTASH_CURRENT_SIGNING_KEY}
    QSTASH_NEXT_SIGNING_KEY: ${env:QSTASH_NEXT_SIGNING_KEY}

functions:
  api:
    image:
      name: appimage
      command:
        - handlers.lambda_handler.api_handler
    events:
      - httpApi: "*" # api gateway v2
    timeout: 30

  worker:
    image:
      name: appimage
      command:
        - handlers.lambda_handler.worker_handler
    timeout: 900 # 15 mins max
    memorySize: 2048 # 2gb ram
    events:
      - httpApi:
          path: /worker
          method: post
